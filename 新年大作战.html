<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°å¹´å¤§ä½œæˆ˜ - èº²é¿å¹´å…½é­ç‚®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #2c0a0a 0%, #4a1010 50%, #6b1515 100%);
            font-family: 'Microsoft YaHei', 'SimHei', sans-serif;
            overflow: hidden;
        }
        #gameContainer {
            position: relative;
        }
        canvas {
            display: block;
            border: 4px solid #ffd700;
            border-radius: 10px;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.4);
            cursor: crosshair;
        }
        #startScreen, #gameOverScreen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(139, 0, 0, 0.95);
            padding: 40px 60px;
            border-radius: 15px;
            text-align: center;
            display: none;
            border: 4px solid #ffd700;
        }
        #startScreen {
            display: block;
            max-width: 500px;
        }
        #startScreen h1 {
            color: #ffd700;
            margin-bottom: 15px;
            font-size: 36px;
        }
        #startScreen h2 {
            color: #ffd700;
            margin: 20px 0 10px 0;
            font-size: 22px;
        }
        #startScreen p {
            color: #fff;
            margin-bottom: 8px;
            font-size: 16px;
            line-height: 1.6;
        }
        .key-badge {
            display: inline-block;
            background: #333;
            border: 2px solid #ffd700;
            border-radius: 5px;
            padding: 3px 8px;
            margin: 0 3px;
            font-family: monospace;
            color: #ffd700;
        }
        .tip {
            background: rgba(255, 215, 0, 0.2);
            border-left: 4px solid #ffd700;
            padding: 10px 15px;
            margin: 15px 0;
            text-align: left;
        }
        #gameOverScreen h1 {
            color: #ffd700;
            margin-bottom: 20px;
            font-size: 36px;
        }
        #gameOverScreen p {
            color: #fff;
            margin-bottom: 15px;
            font-size: 20px;
        }
        #restartBtn {
            background: linear-gradient(135deg, #ff6b6b, #ffd700);
            color: #8b0000;
            border: none;
            padding: 15px 30px;
            font-size: 20px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Microsoft YaHei', sans-serif;
            font-weight: bold;
            transition: all 0.3s;
        }
        #restartBtn:hover, #startBtn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        }
        #startBtn {
            background: linear-gradient(135deg, #ff6b6b, #ffd700);
            color: #8b0000;
            border: none;
            padding: 15px 40px;
            font-size: 22px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Microsoft YaHei', sans-serif;
            font-weight: bold;
            transition: all 0.3s;
            margin-top: 20px;
        }
        #fullscreenBtn {
            position: fixed;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, #8b0000, #dc143c);
            color: #ffd700;
            border: 3px solid #ffd700;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Microsoft YaHei', sans-serif;
            font-weight: bold;
            transition: all 0.3s;
            z-index: 1000;
        }
        #fullscreenBtn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }
        /* å“åº”å¼æ¸¸æˆå®¹å™¨ */
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        canvas {
            max-width: 100vw;
            max-height: 100vh;
            width: auto;
            height: auto;
            object-fit: contain;
            display: block;
        }
        /* éš¾åº¦é€‰æ‹©æŒ‰é’®æ ·å¼ */
        .difficulty-btn {
            background: linear-gradient(135deg, #ff6b6b, #ffd700);
            color: #8b0000;
            border: none;
            padding: 12px 30px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Microsoft YaHei', sans-serif;
            font-weight: bold;
            transition: all 0.3s;
            margin: 5px;
        }
        .difficulty-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        }
        .difficulty-btn.selected {
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            color: #fff;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.8);
        }
        #fullscreenBtn {
            display: none; /* éšè—å…¨å±æŒ‰é’®ï¼Œæ¸¸æˆå·²è‡ªåŠ¨é€‚åº” */
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="800" height="600"></canvas>

        <!-- å¼€å§‹ç•Œé¢ -->
        <div id="startScreen">
            <h1>ğŸŠ æ–°å¹´å¤§ä½œæˆ˜ ğŸŠ</h1>
            <p style="color: #ff6b6b; font-size: 14px;">èº²é¿å¹´å…½çš„é­ç‚®æ”»å‡»ï¼Œå‡»è´¥BOSSè·å¾—èƒœåˆ©ï¼</p>

            <h2>ğŸ® æ“ä½œæŒ‡å—</h2>
            <p>ç§»åŠ¨: <span class="key-badge">â†‘</span><span class="key-badge">â†“</span><span class="key-badge">â†</span><span class="key-badge">â†’</span> æˆ– <span class="key-badge">W</span><span class="key-badge">A</span><span class="key-badge">S</span><span class="key-badge">D</span></p>
            <p>æ”»å‡»: æŒ‰ä½ <span class="key-badge">å·¦é”®</span> æˆ– <span class="key-badge">è§¦æ‘¸</span> æ‹–æ‹½ç„å‡†ï¼Œæ¾å¼€æŠ•æ·</p>

            <h2>ğŸ¯ æ¸¸æˆç›®æ ‡</h2>
            <p>ğŸ”´ èº²é¿å¹´å…½å‘å°„çš„çº¢è‰²é­ç‚®</p>
            <p>ğŸ¥Ÿ æ”¶é›†é¥ºå­æ¢å¤ç”Ÿå‘½å€¼ (å…±3æ¡å‘½)</p>
            <p>ğŸ§¤ æ”¶é›†æ‰‹å¥—åå¯æŠ•æ·æ”»å‡»å¹´å…½</p>
            <p>ğŸ’€ å‡»æ€5åªå¹´å…½åå‡»è´¥BOSSè·èƒœï¼</p>

            <h2>âš”ï¸ é€‰æ‹©éš¾åº¦</h2>
            <div style="margin: 15px 0;">
                <button class="difficulty-btn selected" data-difficulty="heaven">ğŸ˜‡ å¤©å ‚ç‰ˆæœ¬</button>
                <button class="difficulty-btn" data-difficulty="hell">ğŸ”¥ åœ°ç‹±ç‰ˆæœ¬</button>
            </div>
            <p style="font-size: 13px; color: #aaa;">å¤©å ‚ç‰ˆæœ¬ï¼šé€Ÿåº¦è¾ƒæ…¢ï¼Œé€‚åˆæ–°æ‰‹ | åœ°ç‹±ç‰ˆæœ¬ï¼šåŸç‰ˆéš¾åº¦</p>

            <div class="tip">
                <strong>ğŸ’¡ æç¤º:</strong> æ‰‹å¥—å¯ä»¥æŠµæŒ¡ä¸€æ¬¡ä¼¤å®³ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥æ”»å‡»å¹´å…½ï¼
            </div>

            <button id="startBtn">å¼€å§‹æ¸¸æˆ</button>
        </div>

        <div id="gameOverScreen">
            <h1 id="gameOverTitle">æ–°å¹´å¿«ä¹!</h1>
            <p id="gameOverMessage"></p>
            <p>ç”Ÿå­˜æ—¶é—´: <span id="finalTime">00:00</span></p>
            <p>å‡»æ€å¹´å…½: <span id="finalScore">0</span> åª</p>
            <button id="restartBtn">å†æˆ˜ä¸€å¹´</button>
        </div>
    </div>

    <script>
        // ==================== æ¸¸æˆåˆå§‹åŒ– ====================
        const canvas = document.getElementById('gameCanvas');
        if (!canvas) {
            console.error('Canvas element not found!');
            alert('Canvaså…ƒç´ æœªæ‰¾åˆ°ï¼');
        }
        const ctx = canvas.getContext('2d');
        if (!ctx) {
            console.error('Canvas context not available!');
            alert('Canvasä¸Šä¸‹æ–‡ä¸å¯ç”¨ï¼');
        }
        const gameOverScreen = document.getElementById('gameOverScreen');
        const gameOverTitle = document.getElementById('gameOverTitle');
        const gameOverMessage = document.getElementById('gameOverMessage');
        const finalTimeElement = document.getElementById('finalTime');
        const finalScoreElement = document.getElementById('finalScore');
        const restartBtn = document.getElementById('restartBtn');
        const startScreen = document.getElementById('startScreen');
        const startBtn = document.getElementById('startBtn');

        // éš¾åº¦é…ç½®
        const difficultySettings = {
            heaven: {  // å¤©å ‚ç‰ˆæœ¬ï¼ˆå½“å‰æ–°å€¼ï¼‰
                name: 'å¤©å ‚ç‰ˆæœ¬',
                dumplingSpeed: 2,
                gloveSpeed: 1.7,
                nianMoveSpeed: 0.8,
                bossMoveSpeed: 0.5
            },
            hell: {  // åœ°ç‹±ç‰ˆæœ¬ï¼ˆåŸå›°éš¾å€¼ï¼‰
                name: 'åœ°ç‹±ç‰ˆæœ¬',
                dumplingSpeed: 2.5,
                gloveSpeed: 2,
                nianMoveSpeed: 1,
                bossMoveSpeed: 1.5
            }
        };

        // å½“å‰éš¾åº¦
        let currentDifficulty = 'heaven';

        // æ¸¸æˆçŠ¶æ€
        let gameStarted = false; // æ¸¸æˆæ˜¯å¦å·²å¼€å§‹ï¼ˆç‚¹å‡»äº†å¼€å§‹æŒ‰é’®ï¼‰
        let gameRunning = false; // æ¸¸æˆæ˜¯å¦è¿è¡Œä¸­
        let gameWon = false;
        let killedNians = 0; // å‡»æ€çš„å¹´å…½æ•°é‡
        let gameTime = 0; // æ¸¸æˆæ—¶é—´ï¼ˆç§’ï¼‰
        let gameStartTime = Date.now();
        let lastNianSpawn = 0; // ä¸Šæ¬¡ç”Ÿæˆå¹´å…½çš„æ—¶é—´
        let bossActive = false; // BOSSæ˜¯å¦æ¿€æ´»
        let bossDefeated = false; // BOSSæ˜¯å¦è¢«å‡»è´¥

        // å°å·«å©†ï¼ˆäºŒæ¬¡å…ƒåƒç´ é£ï¼‰
        const witch = {
            x: 100,
            y: 300,
            width: 48,
            height: 48,
            speed: 3,
            lives: 3,
            invincible: false,
            invincibleTimer: 0,
            hurtTimer: 0,
            animFrame: 0,
            animTimer: 0,
            hasGlove: false
        };

        // ç„å‡†çŠ¶æ€
        let isAiming = false;
        let aimStartX = 0;
        let aimStartY = 0;
        let aimCurrentX = 0;
        let aimCurrentY = 0;

        // æŠ•æ·çš„æ‰‹å¥—æ•°ç»„
        let thrownGloves = [];

        // æŒ‰é”®çŠ¶æ€
        const keys = {
            ArrowUp: false,
            ArrowDown: false,
            ArrowLeft: false,
            ArrowRight: false,
            w: false,
            a: false,
            s: false,
            d: false,
            W: false,
            A: false,
            S: false,
            D: false
        };

        // å¼¹å¹•ï¼ˆé­ç‚®ï¼‰æ•°ç»„
        let bullets = [];

        // é¥ºå­æ•°ç»„
        let dumplings = [];

        // æ‰‹å¥—æ•°ç»„
        let gloves = [];

        // çƒŸèŠ±æ•ˆæœæ•°ç»„
        let fireworks = [];

        // ç²’å­æ•ˆæœæ•°ç»„ï¼ˆç”¨äºBOSSæ­»äº¡ï¼‰
        let particles = [];

        // å¹´å…½æ•°ç»„ï¼ˆåŠ¨æ€ç”Ÿæˆï¼‰
        let nians = [];

        // BOSSå¹´å…½
        let bossNian = null;

        // ç¯ç¬¼è£…é¥°
        const lanterns = [];
        for (let i = 0; i < 3; i++) {
            lanterns.push({
                x: 150 + i * 250,
                y: 30,
                swing: 0
            });
        }

        // èƒŒæ™¯çƒŸèŠ±å®šæ—¶å™¨
        let lastBackgroundFirework = 0;

        // è¾¹ç•Œï¼ˆæœ€å³è¾¹ç¯ç¬¼ä¸‹æ–¹ï¼‰
        const boundaryX = 650 + 70;

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // ç»˜åˆ¶åƒç´ é£äºŒæ¬¡å…ƒå°å·«å©†
        function drawWitch() {
            const x = Math.floor(witch.x);
            const y = Math.floor(witch.y);
            const frame = Math.floor(witch.animFrame) % 4;

            ctx.save();

            // å—å‡»æŠ–åŠ¨æ•ˆæœ
            let offsetX = 0;
            let offsetY = 0;
            if (witch.hurtTimer > 0) {
                offsetX = Math.sin(witch.hurtTimer * 3) * 4;
                offsetY = Math.cos(witch.hurtTimer * 2) * 3;
                witch.hurtTimer--;
            }

            ctx.translate(offsetX, offsetY);

            // æ— æ•Œé—ªçƒæ•ˆæœ
            if (witch.invincible && Math.floor(Date.now() / 80) % 2 === 0) {
                ctx.globalAlpha = 0.5;
            }

            // æ‰«æŠŠï¼ˆåƒç´ é£é‡‘è‰²ï¼‰
            const broomOffset = Math.sin(frame * Math.PI / 2) * 2;
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(x + 8, y + 30 + broomOffset, 32, 4);
            ctx.fillStyle = '#DAA520';
            ctx.fillRect(x + 10, y + 32 + broomOffset, 28, 2);

            // æ‰«æŠŠæ¯›ï¼ˆåˆ†å±‚åƒç´ ï¼‰
            for (let i = 0; i < 6; i++) {
                ctx.fillStyle = i % 2 === 0 ? '#FFD700' : '#DAA520';
                ctx.fillRect(x + 38 + i * 3, y + 26 + broomOffset + Math.floor(i / 2) * 2, 4, 10);
            }

            // èº«ä½“ï¼ˆäºŒæ¬¡å…ƒé£æ ¼çº¢è‰²æ–—ç¯·ï¼‰
            ctx.fillStyle = '#E91E63';
            ctx.fillRect(x + 14, y + 18, 20, 18);
            ctx.fillStyle = '#FF4081';
            ctx.fillRect(x + 16, y + 20, 16, 14);
            ctx.fillStyle = '#F8BBD0';
            ctx.fillRect(x + 18, y + 22, 12, 10);

            // è…°å¸¦ï¼ˆé‡‘è‰²ï¼‰
            ctx.fillStyle = '#FFD700';
            ctx.fillRect(x + 14, y + 30, 20, 3);

            // åŒè…¿ï¼ˆå¸¦åŠ¨ç”»ï¼‰
            ctx.fillStyle = '#FFE4C4';
            const legSwing = Math.sin(frame * Math.PI / 2) * 2;
            if (frame % 2 === 0) {
                ctx.fillRect(x + 16, y + 33, 5, 8 + legSwing);
                ctx.fillRect(x + 27, y + 33, 5, 8 - legSwing);
            } else {
                ctx.fillRect(x + 16, y + 33, 5, 8 - legSwing);
                ctx.fillRect(x + 27, y + 33, 5, 8 + legSwing);
            }

            // å¤´éƒ¨ï¼ˆäºŒæ¬¡å…ƒè„¸å‹ï¼‰
            ctx.fillStyle = '#FFE4C4';
            ctx.fillRect(x + 12, y + 4, 24, 16);

            // å¤´å‘ï¼ˆç´«è‰²é•¿å‘ï¼‰
            ctx.fillStyle = '#9C27B0';
            ctx.fillRect(x + 10, y + 2, 28, 6);
            ctx.fillRect(x + 8, y + 6, 4, 14);
            ctx.fillRect(x + 36, y + 6, 4, 14);

            // åˆ˜æµ·ï¼ˆäºŒæ¬¡å…ƒé£æ ¼ï¼‰
            ctx.fillStyle = '#AB47BC';
            ctx.fillRect(x + 12, y + 2, 6, 6);
            ctx.fillRect(x + 18, y + 2, 5, 5);
            ctx.fillRect(x + 23, y + 2, 5, 5);
            ctx.fillRect(x + 28, y + 2, 6, 6);

            // å¸½å­ï¼ˆå·«å¸ˆå¸½ï¼Œç´«è‰²ï¼‰
            ctx.fillStyle = '#7B1FA2';
            ctx.fillRect(x + 14, y - 6, 20, 10);
            ctx.fillRect(x + 20, y - 12, 8, 8);

            // å¸½å­æ˜Ÿæ˜Ÿè£…é¥°
            ctx.fillStyle = '#FFD700';
            ctx.fillRect(x + 22, y - 8, 4, 4);
            ctx.fillRect(x + 21, y - 7, 2, 2);

            // å¤§çœ¼ç›ï¼ˆäºŒæ¬¡å…ƒé£æ ¼ï¼‰
            // å·¦çœ¼
            ctx.fillStyle = '#fff';
            ctx.fillRect(x + 14, y + 8, 6, 6);
            ctx.fillStyle = '#E91E63';
            ctx.fillRect(x + 15, y + 9, 4, 4);
            ctx.fillStyle = '#000';
            ctx.fillRect(x + 16, y + 10, 2, 2);
            // å³çœ¼
            ctx.fillStyle = '#fff';
            ctx.fillRect(x + 28, y + 8, 6, 6);
            ctx.fillStyle = '#E91E63';
            ctx.fillRect(x + 29, y + 9, 4, 4);
            ctx.fillStyle = '#000';
            ctx.fillRect(x + 30, y + 10, 2, 2);

            // çœ¼ç›é«˜å…‰
            ctx.fillStyle = '#fff';
            ctx.fillRect(x + 16, y + 9, 2, 1);
            ctx.fillRect(x + 30, y + 9, 2, 1);

            // å°å˜´å·´ï¼ˆäºŒæ¬¡å…ƒé£æ ¼ï¼‰
            ctx.fillStyle = '#FF80AB';
            ctx.fillRect(x + 22, y + 16, 4, 2);

            // è…®çº¢
            ctx.fillStyle = 'rgba(255, 128, 171, 0.6)';
            ctx.fillRect(x + 10, y + 13, 4, 3);
            ctx.fillRect(x + 34, y + 13, 4, 3);

            // å¦‚æœæœ‰æ‰‹å¥—ï¼Œç”»å‡ºæ‰‹å¥—
            if (witch.hasGlove) {
                ctx.fillStyle = '#FF8A65';
                ctx.fillRect(x + 40, y + 10, 8, 8);
                ctx.fillStyle = '#FFAB91';
                ctx.fillRect(x + 41, y + 11, 3, 3);
                ctx.fillRect(x + 44, y + 12, 3, 3);
            }

            ctx.restore();
        }

        // ç»˜åˆ¶å¹´å…½ï¼ˆæ™®é€šå¹´å…½å’ŒBOSSå¹´å…½ï¼‰
        function drawNian(nian) {
            const x = nian.x;
            const y = nian.y;
            const frame = Math.floor(nian.animFrame) % 2;
            const isBoss = nian.isBoss || false;

            ctx.save();

            // è®¡ç®—éœ‡åŠ¨åç§»ï¼ˆå¹…åº¦å°ä¸”é€’å‡ï¼‰
            let shakeOffsetX = 0;
            let shakeOffsetY = 0;
            if (nian.shakeAmplitude > 0) {
                shakeOffsetX = Math.sin(nian.shakePhase) * nian.shakeAmplitude;
                shakeOffsetY = Math.cos(nian.shakePhase * 1.3) * nian.shakeAmplitude;
            }

            // åº”ç”¨éœ‡åŠ¨åç§»
            ctx.translate(shakeOffsetX, shakeOffsetY);

            // å—å‡»é—ªçƒæ•ˆæœ
            if (nian.hitTimer > 0) {
                ctx.globalAlpha = 0.6;
                nian.hitTimer--;
            }

            // BOSSå¹´å…½å¤§ä¸€äº›ï¼ˆ1.5å€ï¼‰ï¼Œæ™®é€šå¹´å…½å°ä¸€ç‚¹ï¼ˆ0.75å€ï¼‰
            const scale = isBoss ? 1.2 : 0.75;
            const offsetX = (1 - scale) * 40;
            const offsetY = (1 - scale) * 40;

            // èº«ä½“
            ctx.fillStyle = '#D32F2F';
            ctx.fillRect(x + 20 - offsetX, y + 30 - offsetY, 50 * scale, 40 * scale);

            // å¤´
            ctx.fillStyle = '#F44336';
            ctx.fillRect(x + 10 - offsetX, y + 10 - offsetY, 60 * scale, 30 * scale);

            // çœ¼ç›
            ctx.fillStyle = '#FFEB3B';
            ctx.fillRect(x + 20 - offsetX, y + 18 - offsetY, 12 * scale, 12 * scale);
            ctx.fillRect(x + 45 - offsetX, y + 18 - offsetY, 12 * scale, 12 * scale);

            // çœ¼ç 
            ctx.fillStyle = '#000';
            ctx.fillRect(x + 25 - offsetX, y + 22 - offsetY, 4 * scale, 4 * scale);
            ctx.fillRect(x + 50 - offsetX, y + 22 - offsetY, 4 * scale, 4 * scale);

            // å˜´å·´
            ctx.fillStyle = '#fff';
            ctx.fillRect(x + 25 - offsetX, y + 35 - offsetY, 30 * scale, 8 * scale);
            ctx.fillStyle = '#f00';
            const teethOffset = frame === 0 ? 0 : 2;
            ctx.fillRect(x + 28 - offsetX + teethOffset, y + 35 - offsetY, 4 * scale, 8 * scale);
            ctx.fillRect(x + 36 - offsetX + teethOffset, y + 35 - offsetY, 4 * scale, 8 * scale);
            ctx.fillRect(x + 44 - offsetX + teethOffset, y + 35 - offsetY, 4 * scale, 8 * scale);

            // è§’
            ctx.fillStyle = '#FFD700';
            const hornSize = isBoss ? 8 : 5;
            ctx.beginPath();
            ctx.moveTo(x + 15 - offsetX, y + 10 - offsetY);
            ctx.lineTo(x + 20 - offsetX, y + 10 - offsetY - hornSize);
            ctx.lineTo(x + 25 - offsetX, y + 10 - offsetY);
            ctx.fill();
            ctx.beginPath();
            ctx.moveTo(x + 55 - offsetX, y + 10 - offsetY);
            ctx.lineTo(x + 60 - offsetX, y + 10 - offsetY - hornSize);
            ctx.lineTo(x + 65 - offsetX, y + 10 - offsetY);
            ctx.fill();

            // BOSSæ€’å¼ç‰¹æ•ˆ
            if (isBoss && nian.isRoaring) {
                ctx.strokeStyle = 'rgba(255, 0, 0, 0.6)';
                ctx.lineWidth = 3;
                for (let i = 0; i < 8; i++) {
                    const angle = (i * 45) * Math.PI / 180;
                    ctx.beginPath();
                    ctx.moveTo(x + 40 - offsetX, y + 40 - offsetY);
                    ctx.lineTo(x + 40 - offsetX + Math.cos(angle) * 60, y + 40 - offsetY + Math.sin(angle) * 60);
                    ctx.stroke();
                }
            }

            // è…¿
            ctx.fillStyle = '#D32F2F';
            if (frame === 0) {
                ctx.fillRect(x + 25 - offsetX, y + 70 - offsetY, 10 * scale, 10 * scale);
                ctx.fillRect(x + 55 - offsetX, y + 70 - offsetY, 10 * scale, 10 * scale);
            } else {
                ctx.fillRect(x + 30 - offsetX, y + 70 - offsetY, 10 * scale, 10 * scale);
                ctx.fillRect(x + 50 - offsetX, y + 70 - offsetY, 10 * scale, 10 * scale);
            }

            ctx.restore();
        }

        // ç»˜åˆ¶é­ç‚®å¼¹å¹•
        function drawBullets() {
            bullets.forEach(bullet => {
                ctx.save();
                ctx.translate(bullet.x, bullet.y);
                ctx.rotate(bullet.angle);

                // é­ç‚®ä¸»ä½“ï¼ˆçº¢è‰²åœ†ç­’ï¼‰
                ctx.fillStyle = '#ff4444';
                ctx.fillRect(-bullet.size, -bullet.size * 0.6, bullet.size * 2, bullet.size * 1.2);

                // é­ç‚®é¡¶éƒ¨é‡‘è‰²è£…é¥°
                ctx.fillStyle = '#ffd700';
                ctx.fillRect(-bullet.size, -bullet.size * 0.6, bullet.size * 2, 3);

                // é­ç‚®åº•éƒ¨é‡‘è‰²è£…é¥°
                ctx.fillRect(-bullet.size, bullet.size * 0.6 - 3, bullet.size * 2, 3);

                // å¼•çº¿ï¼ˆåŠ¨æ€é—ªçƒï¼‰
                ctx.strokeStyle = '#8B4513';
                ctx.lineWidth = 2;
                const flicker = Math.sin(Date.now() / 50) * 2;
                ctx.beginPath();
                ctx.moveTo(bullet.size, 0);
                ctx.lineTo(bullet.size + 8, -3 + flicker);
                ctx.stroke();

                // å‘å…‰æ•ˆæœ
                ctx.shadowBlur = 15;
                ctx.shadowColor = '#ff4444';

                ctx.restore();
            });
        }

        // ç»˜åˆ¶é¥ºå­ï¼ˆEmojiç‰ˆï¼‰
        function drawDumplings() {
            dumplings.forEach(dumpling => {
                ctx.save();

                // æ·»åŠ è½»å¾®é˜´å½±
                ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                ctx.shadowBlur = 8;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;

                // ç»˜åˆ¶é¥ºå­emoji
                ctx.font = '26px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('ğŸ¥Ÿ', dumpling.x, dumpling.y);

                ctx.restore();
            });
        }

        // ç»˜åˆ¶æ‰‹å¥—ï¼ˆEmojiç‰ˆï¼‰
        function drawGloves() {
            gloves.forEach(glove => {
                ctx.save();

                // æ·»åŠ è½»å¾®é˜´å½±
                ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                ctx.shadowBlur = 8;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;

                // ç»˜åˆ¶æ‰‹å¥—emoji
                ctx.font = '22px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('ğŸ§¤', glove.x, glove.y);

                ctx.restore();
            });
        }

        // ç»˜åˆ¶æŠ•æ·çš„æ‰‹å¥—ï¼ˆEmojiç‰ˆï¼‰
        function drawThrownGloves() {
            thrownGloves.forEach(glove => {
                ctx.save();

                const centerX = glove.x;
                const centerY = glove.y;

                // ç§»åŠ¨åˆ°ä¸­å¿ƒç‚¹ä»¥ä¾¿æ—‹è½¬
                ctx.translate(centerX, centerY);
                ctx.rotate(glove.rotation);
                ctx.translate(-centerX, -centerY);

                // æ·»åŠ è½»å¾®é˜´å½±
                ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                ctx.shadowBlur = 8;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;

                // ç»˜åˆ¶æ‰‹å¥—emoji
                ctx.font = '22px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('ğŸ§¤', centerX, centerY);

                ctx.restore();
            });
        }

        // ç»˜åˆ¶æ„¤æ€’çš„å°é¸Ÿé£æ ¼æ‹–æ‹½ç„å‡†
        function drawTrajectory() {
            if (!witch.hasGlove || !isAiming) return;

            const startX = witch.x + 44;
            const startY = witch.y + 14;

            // è®¡ç®—æ‹–æ‹½å‘é‡ï¼ˆåå‘ï¼‰
            const dx = aimStartX - aimCurrentX;
            const dy = aimStartY - aimCurrentY;

            // é™åˆ¶æœ€å¤§æ‹‰åŠ›
            const maxPull = 150;
            const pullDistance = Math.min(Math.sqrt(dx * dx + dy * dy), maxPull);
            const angle = Math.atan2(dy, dx);

            // åŠ›åº¦ç³»æ•°
            const power = pullDistance / 10;

            // ç»˜åˆ¶æ‹–æ‹½çº¿ï¼ˆåå‘å¼¹å¼“ï¼‰
            ctx.save();
            ctx.strokeStyle = 'rgba(255, 215, 0, 0.8)';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(startX - dx * 0.5, startY - dy * 0.5);
            ctx.stroke();

            // ç»˜åˆ¶åŠ›åº¦åœˆ
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.arc(startX, startY, pullDistance * 0.3, 0, Math.PI * 2);
            ctx.stroke();
            ctx.setLineDash([]);

            // ç»˜åˆ¶é¢„æµ‹è½¨è¿¹
            if (pullDistance > 20) {
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
                ctx.lineWidth = 2;
                ctx.setLineDash([8, 8]);

                ctx.beginPath();
                ctx.moveTo(startX, startY);

                let vx = Math.cos(angle) * power;
                let vy = Math.sin(angle) * power;
                let px = startX;
                let py = startY;
                const gravity = 0.3;

                // ç»˜åˆ¶å‰20å¸§çš„è½¨è¿¹
                for (let i = 0; i < 20; i++) {
                    px += vx;
                    py += vy;
                    vy += gravity;
                    ctx.lineTo(px, py);
                }

                ctx.stroke();
                ctx.setLineDash([]);

                // ç»˜åˆ¶è½ç‚¹æ ‡è®°
                ctx.fillStyle = 'rgba(255, 215, 0, 0.6)';
                ctx.beginPath();
                ctx.arc(px, py, 6, 0, Math.PI * 2);
                ctx.fill();
            }

            ctx.restore();
        }

        // ç»˜åˆ¶çƒŸèŠ±æ•ˆæœ
        function drawFireworks() {
            fireworks = fireworks.filter(fw => {
                fw.life--;

                ctx.save();
                ctx.globalAlpha = fw.life / 40;

                fw.particles.forEach(p => {
                    ctx.fillStyle = p.color;
                    ctx.beginPath();
                    ctx.arc(fw.x + p.x, fw.y + p.y, p.size, 0, Math.PI * 2);
                    ctx.fill();

                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.08;
                    p.size *= 0.97;
                });

                ctx.restore();
                return fw.life > 0 && fw.particles[0].size > 0.5;
            });
        }

        // ç»˜åˆ¶èƒŒæ™¯
        function drawBackground() {
            // æ–°å¹´çº¢è‰²æ¸å˜èƒŒæ™¯
            const gradient = ctx.createLinearGradient(0, 0, 0, 600);
            gradient.addColorStop(0, '#1a0505');
            gradient.addColorStop(0.3, '#2d0a0a');
            gradient.addColorStop(0.7, '#4a1010');
            gradient.addColorStop(1, '#6b1515');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 800, 600);

            // ç»˜åˆ¶ç¯ç¬¼
            lanterns.forEach((lantern, index) => {
                lantern.swing += 0.05;
                const swingX = Math.sin(lantern.swing) * 5;

                ctx.save();

                // ç¯ç¬¼çº¿
                ctx.strokeStyle = '#ffd700';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(lantern.x + swingX, 0);
                ctx.lineTo(lantern.x + swingX, lantern.y);
                ctx.stroke();

                // ç¯ç¬¼ä¸»ä½“
                const gradient = ctx.createRadialGradient(
                    lantern.x + swingX, lantern.y + 25, 0,
                    lantern.x + swingX, lantern.y + 25, 25
                );
                gradient.addColorStop(0, '#ff6b6b');
                gradient.addColorStop(1, '#dc143c');
                ctx.fillStyle = gradient;

                ctx.beginPath();
                ctx.ellipse(lantern.x + swingX, lantern.y + 25, 25, 20, 0, 0, Math.PI * 2);
                ctx.fill();

                // ç¯ç¬¼é‡‘è‰²è¾¹æ¡†
                ctx.strokeStyle = '#ffd700';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.ellipse(lantern.x + swingX, lantern.y + 25, 25, 20, 0, 0, Math.PI * 2);
                ctx.stroke();

                // ç¯ç¬¼é¡¶éƒ¨å’Œåº•éƒ¨
                ctx.fillStyle = '#ffd700';
                ctx.fillRect(lantern.x + swingX - 10, lantern.y, 20, 5);
                ctx.fillRect(lantern.x + swingX - 10, lantern.y + 45, 20, 5);

                // ç¦
                ctx.fillStyle = '#ffd700';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ç¦', lantern.x + swingX, lantern.y + 32);

                // æµè‹
                ctx.strokeStyle = '#ffd700';
                ctx.lineWidth = 2;
                for (let i = -2; i <= 2; i++) {
                    ctx.beginPath();
                    ctx.moveTo(lantern.x + swingX + i * 5, lantern.y + 50);
                    ctx.lineTo(lantern.x + swingX + i * 5, lantern.y + 70);
                    ctx.stroke();
                }

                ctx.restore();
            });

            // ç»˜åˆ¶è¾¹ç•Œçº¿
            ctx.strokeStyle = 'rgba(255, 0, 0, 0.5)';
            ctx.lineWidth = 3;
            ctx.setLineDash([10, 5]);
            ctx.beginPath();
            ctx.moveTo(boundaryX, 0);
            ctx.lineTo(boundaryX, 600);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        // ç»˜åˆ¶UI
        function drawUI() {
            // æ ‡é¢˜
            ctx.fillStyle = '#ffd700';
            ctx.font = 'bold 28px Microsoft YaHei';
            ctx.textAlign = 'center';
            ctx.fillText('æ–°å¹´å¤§ä½œæˆ˜', 400, 35);

            // æ—¶é—´
            ctx.textAlign = 'left';
            ctx.font = 'bold 24px Microsoft YaHei';
            ctx.fillStyle = '#fff';
            ctx.fillText(`æ—¶é—´: ${formatTime(gameTime)}`, 20, 75);

            // å‡»æ€å¹´å…½æ•°é‡
            ctx.font = 'bold 24px Microsoft YaHei';
            ctx.fillText(`å‡»æ€: ${killedNians}/5`, 20, 100);

            // æ“ä½œæç¤º
            if (witch.hasGlove) {
                ctx.font = '16px Microsoft YaHei';
                ctx.fillStyle = '#fff';
                ctx.textAlign = 'right';
                ctx.fillText('æŒ‰ä½å·¦é”®æ‹–æ‹½ç„å‡†ï¼Œæ¾å¼€æŠ•æ·', 780, 580);
            }

            // BOSSè¡€æ¡
            if (bossActive && bossNian) {
                const bossMaxHp = 5;
                const currentHp = bossNian.hp;
                const barWidth = 300;
                const barHeight = 25;
                const barX = 400 - barWidth / 2;
                const barY = 55;

                // è¡€æ¡èƒŒæ™¯
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(barX - 5, barY - 5, barWidth + 10, barHeight + 10);

                // è¡€æ¡å¤–æ¡†
                ctx.strokeStyle = '#ffd700';
                ctx.lineWidth = 3;
                ctx.strokeRect(barX, barY, barWidth, barHeight);

                // è¡€æ¡å¡«å……
                const hpRatio = currentHp / bossMaxHp;
                const gradient = ctx.createLinearGradient(barX, barY, barX + barWidth * hpRatio, barY);
                gradient.addColorStop(0, '#ff0000');
                gradient.addColorStop(0.5, '#ff6600');
                gradient.addColorStop(1, '#ffff00');
                ctx.fillStyle = gradient;
                ctx.fillRect(barX + 2, barY + 2, (barWidth - 4) * hpRatio, barHeight - 4);

                // BOSSè¡€é‡æ–‡å­—
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 16px Microsoft YaHei';
                ctx.textAlign = 'center';
                ctx.fillText(`BOSSå¹´å…½ ${currentHp}/${bossMaxHp}`, 400, barY + 18);
            }

            // ç”Ÿå‘½å€¼ï¼ˆé¥ºå­ï¼‰
            ctx.textAlign = 'left';
            for (let i = 0; i < 3; i++) {
                if (i < witch.lives) {
                    ctx.fillStyle = '#fffaf0';
                    ctx.strokeStyle = '#ffd700';
                } else {
                    ctx.fillStyle = '#333';
                    ctx.strokeStyle = '#555';
                }
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(690 + i * 40, 80, 12, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();
            }
        }

        // ä»æŒ‡å®šå¹´å…½å‘å°„å¼¹å¹•
        function spawnBulletFromNian(nian) {
            const baseSpeed = 2.5; // ç§»é™¤difficultyä¾èµ–ï¼Œä½¿ç”¨å›ºå®šé€Ÿåº¦
            const types = [
                { angle: Math.PI, speed: baseSpeed },
                { angle: Math.PI + Math.PI / 10, speed: baseSpeed * 0.95 },
                { angle: Math.PI - Math.PI / 10, speed: baseSpeed * 0.95 },
                { angle: Math.PI + Math.PI / 8, speed: baseSpeed * 0.93 },
                { angle: Math.PI - Math.PI / 8, speed: baseSpeed * 0.93 },
                { angle: Math.PI + Math.PI / 6, speed: baseSpeed * 0.9 },
                { angle: Math.PI - Math.PI / 6, speed: baseSpeed * 0.9 },
                { angle: Math.PI + Math.PI / 5, speed: baseSpeed * 0.88 },
                { angle: Math.PI - Math.PI / 5, speed: baseSpeed * 0.88 },
                { angle: Math.PI + Math.PI / 4, speed: baseSpeed * 0.85 },
                { angle: Math.PI - Math.PI / 4, speed: baseSpeed * 0.85 }
            ];

            const maxTypeIndex = types.length - 1; // ä½¿ç”¨æ‰€æœ‰å¼¹å¹•ç±»å‹
            const typeIndex = Math.floor(Math.random() * (maxTypeIndex + 1));
            const type = types[typeIndex];

            // éšæœºå‘å°„1-3ä¸ªå¼¹å¹•
            const bulletCount = 1 + Math.floor(Math.random() * 3);

            for (let i = 0; i < bulletCount; i++) {
                // ä¸ºæ¯ä¸ªå¼¹å¹•å•ç‹¬è®¡ç®—éšæœºè§’åº¦åç§»ï¼Œè®©è½¨è¿¹æ›´åˆ†æ•£
                const angleOffset = (Math.random() - 0.5) * 0.4; // å¢åŠ è§’åº¦éšæœºèŒƒå›´
                const speedOffset = (Math.random() - 0.5) * 0.8; // å¢åŠ é€Ÿåº¦éšæœºèŒƒå›´
                const positionOffset = (Math.random() - 0.5) * 40; // è°ƒæ•´å‘å°„ä½ç½®éšæœºèŒƒå›´

                bullets.push({
                    x: nian.x,
                    y: nian.y + 30 + positionOffset, // è°ƒæ•´åˆ°å¹´å…½ä¸­å¿ƒ
                    size: 12 + Math.random() * 13,
                    angle: type.angle + angleOffset,
                    speed: Math.max(1.5, type.speed + speedOffset),
                    color: '#ff4444'
                });
            }
        }

        // ç”Ÿæˆé¥ºå­
        function spawnDumpling() {
            dumplings.push({
                x: Math.random() * 600 + 50,
                y: -20,
                speed: difficultySettings[currentDifficulty].dumplingSpeed
            });
        }

        // ç”Ÿæˆæ‰‹å¥—
        function spawnGlove() {
            gloves.push({
                x: Math.random() * 600 + 50,
                y: -20,
                speed: difficultySettings[currentDifficulty].gloveSpeed
            });
        }

        // åˆ›å»ºçƒŸèŠ±
        function createFirework(x, y) {
            const colors = ['#ff0000', '#ffd700', '#ff69b4', '#E91E63', '#00ff00', '#00ffff', '#9C27B0'];
            const particles = [];
            const particleCount = 25;
            for (let i = 0; i < particleCount; i++) {
                const angle = (i * 360 / particleCount) * Math.PI / 180;
                const speed = 2 + Math.random() * 3;
                particles.push({
                    x: 0,
                    y: 0,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    size: 2 + Math.random() * 2
                });
            }
            fireworks.push({
                x: x,
                y: y,
                life: 40,
                particles: particles
            });
        }

        // ç”ŸæˆèƒŒæ™¯çƒŸèŠ±
        function spawnBackgroundFirework() {
            createFirework(
                100 + Math.random() * 600,
                100 + Math.random() * 300
            );
        }

        // æ›´æ–°å°å·«å©†
        function updateWitch() {
            // æ”¯æŒç®­å¤´é”®å’ŒWASD
            if (keys.ArrowUp || keys.w || keys.W) witch.y -= witch.speed;
            if (keys.ArrowDown || keys.s || keys.S) witch.y += witch.speed;
            if (keys.ArrowLeft || keys.a || keys.A) witch.x -= witch.speed;
            if (keys.ArrowRight || keys.d || keys.D) witch.x += witch.speed;

            // è¾¹ç•Œé™åˆ¶
            witch.x = Math.max(0, Math.min(boundaryX - 48, witch.x));
            witch.y = Math.max(0, Math.min(552, witch.y));

            witch.animTimer++;
            if (witch.animTimer > 8) {
                witch.animFrame++;
                witch.animTimer = 0;
            }

            if (witch.invincible) {
                witch.invincibleTimer--;
                if (witch.invincibleTimer <= 0) {
                    witch.invincible = false;
                }
            }
        }

        // ç”Ÿæˆå¹´å…½ï¼ˆæ¯15ç§’åœ¨è¾¹ç•Œåç”Ÿæˆï¼‰
        function spawnNian() {
            if (bossActive) return; // BOSSå‡ºç°åä¸å†ç”Ÿæˆæ™®é€šå¹´å…½

            nians.push({
                x: boundaryX + 10, // è¾¹ç•Œå³ä¾§
                y: 100 + Math.random() * 400,
                width: 60, // ç¼©å°å°ºå¯¸
                height: 60,
                animFrame: 0,
                animTimer: 0,
                lastFire: 0,
                fireRate: 800 + Math.random() * 600,
                hitTimer: 0,
                hp: 2, // 2æ¬¡è¢«æ‰“åæ­»äº¡
                isBoss: false,
                isEscaping: false,
                escapeSpeed: 0,
                moveDirection: Math.random() > 0.5 ? 1 : -1, // ç§»åŠ¨æ–¹å‘
                moveSpeed: difficultySettings[currentDifficulty].nianMoveSpeed, // ç§»åŠ¨é€Ÿåº¦
                isHit: false, // æ˜¯å¦å—å‡»
                hitFreezeTimer: 0, // å—å‡»é¡¿å¸§è®¡æ—¶å™¨ï¼ˆ0.1s = 6å¸§ï¼‰
                shakeTimer: 0, // éœ‡åŠ¨è®¡æ—¶å™¨ï¼ˆ0.5s = 30å¸§ï¼‰
                shakeAmplitude: 0, // å½“å‰éœ‡åŠ¨å¹…åº¦
                shakePhase: 0 // éœ‡åŠ¨ç›¸ä½
            });
        }

        // ç”Ÿæˆåˆå§‹å¹´å…½ï¼ˆæ¸¸æˆå¼€å§‹æ—¶ç”Ÿæˆä¸¤åªï¼‰
        function spawnInitialNians() {
            // ç¬¬ä¸€åªå¹´å…½ - ä¸Šæ–¹åŒºåŸŸ
            nians.push({
                x: boundaryX + 10, // è¾¹ç•Œå³ä¾§
                y: 100,
                width: 60, // ç¼©å°å°ºå¯¸
                height: 60,
                animFrame: 0,
                animTimer: 0,
                lastFire: 0,
                fireRate: 800 + Math.random() * 600,
                hitTimer: 0,
                hp: 2,
                isBoss: false,
                isEscaping: false,
                escapeSpeed: 0,
                moveDirection: 1,
                moveSpeed: difficultySettings[currentDifficulty].nianMoveSpeed,
                isHit: false, // æ˜¯å¦å—å‡»
                hitFreezeTimer: 0, // å—å‡»é¡¿å¸§è®¡æ—¶å™¨ï¼ˆ0.1s = 6å¸§ï¼‰
                shakeTimer: 0, // éœ‡åŠ¨è®¡æ—¶å™¨ï¼ˆ0.5s = 30å¸§ï¼‰
                shakeAmplitude: 0, // å½“å‰éœ‡åŠ¨å¹…åº¦
                shakePhase: 0 // éœ‡åŠ¨ç›¸ä½
            });

            // ç¬¬äºŒåªå¹´å…½ - ä¸‹æ–¹åŒºåŸŸ
            nians.push({
                x: boundaryX + 10, // è¾¹ç•Œå³ä¾§
                y: 420,
                width: 60, // ç¼©å°å°ºå¯¸
                height: 60,
                animFrame: 0,
                animTimer: 0,
                lastFire: 0,
                fireRate: 800 + Math.random() * 600,
                hitTimer: 0,
                hp: 2,
                isBoss: false,
                isEscaping: false,
                escapeSpeed: 0,
                moveDirection: -1,
                moveSpeed: difficultySettings[currentDifficulty].nianMoveSpeed,
                isHit: false, // æ˜¯å¦å—å‡»
                hitFreezeTimer: 0, // å—å‡»é¡¿å¸§è®¡æ—¶å™¨ï¼ˆ0.1s = 6å¸§ï¼‰
                shakeTimer: 0, // éœ‡åŠ¨è®¡æ—¶å™¨ï¼ˆ0.5s = 30å¸§ï¼‰
                shakeAmplitude: 0, // å½“å‰éœ‡åŠ¨å¹…åº¦
                shakePhase: 0 // éœ‡åŠ¨ç›¸ä½
            });
        }

        // ç”ŸæˆBOSSå¹´å…½
        function spawnBossNian() {
            bossActive = true;
            bossNian = {
                x: boundaryX + 100,
                y: 260,
                width: 120,
                height: 120,
                animFrame: 0,
                animTimer: 0,
                lastFire: 0,
                fireRate: 2000,
                hitTimer: 0,
                hp: 5, // 5æ¬¡è¢«æ‰“åæ­»äº¡
                isBoss: true,
                isEscaping: false,
                isRoaring: false,
                roarTimer: 0,
                moveTimer: 0,
                state: 'entering', // entering, moving, attacking
                targetX: 400,
                targetY: 300,
                isHit: false, // æ˜¯å¦å—å‡»
                hitFreezeTimer: 0, // å—å‡»é¡¿å¸§è®¡æ—¶å™¨ï¼ˆ0.1s = 6å¸§ï¼‰
                shakeTimer: 0, // éœ‡åŠ¨è®¡æ—¶å™¨ï¼ˆ0.5s = 30å¸§ï¼‰
                shakeAmplitude: 0, // å½“å‰éœ‡åŠ¨å¹…åº¦
                shakePhase: 0 // éœ‡åŠ¨ç›¸ä½
            };
        }

        // æ›´æ–°å¹´å…½
        function updateNians(timestamp) {
            // æ›´æ–°æ™®é€šå¹´å…½
            nians.forEach(nian => {
                // å¤„ç†å—å‡»é¡¿å¸§å’Œéœ‡åŠ¨
                if (nian.hitFreezeTimer > 0) {
                    nian.hitFreezeTimer--;
                    // é¡¿å¸§æœŸé—´ä¸æ›´æ–°å…¶ä»–çŠ¶æ€
                    return;
                }

                // å¤„ç†éœ‡åŠ¨æ•ˆæœ
                if (nian.shakeTimer > 0) {
                    nian.shakeTimer--;
                    nian.shakePhase += 0.8; // éœ‡åŠ¨é¢‘ç‡
                    // å¹…åº¦é€’å‡ï¼šä»3é€æ¸å‡å°åˆ°0
                    nian.shakeAmplitude = 3 * (nian.shakeTimer / 30);
                } else {
                    nian.shakeAmplitude = 0;
                }

                nian.animTimer++;
                if (nian.animTimer > 15) {
                    nian.animFrame++;
                    nian.animTimer = 0;
                }

                // ä¸Šä¸‹å¾€å¤ç§»åŠ¨é€»è¾‘
                nian.y += nian.moveDirection * nian.moveSpeed;
                // è¾¹ç•Œæ£€æµ‹ï¼Œç¢°åˆ°è¾¹ç•Œåå‘
                if (nian.y <= 50) {
                    nian.y = 50;
                    nian.moveDirection = 1;
                } else if (nian.y >= 470) {
                    nian.y = 470;
                    nian.moveDirection = -1;
                }

                // æ£€æŸ¥æ˜¯å¦éœ€è¦å‘å°„å¼¹å¹•
                if (!bossActive) {
                    const fireRate = Math.max(400, nian.fireRate);
                    if (timestamp - nian.lastFire > fireRate) {
                        spawnBulletFromNian(nian);
                        nian.lastFire = timestamp;
                        nian.fireRate = 600 + Math.random() * 800;
                    }
                }
            });

            // æ›´æ–°BOSSå¹´å…½
            if (bossNian) {
                // å¤„ç†å—å‡»é¡¿å¸§å’Œéœ‡åŠ¨
                if (bossNian.hitFreezeTimer > 0) {
                    bossNian.hitFreezeTimer--;
                    // é¡¿å¸§æœŸé—´ä¸æ›´æ–°å…¶ä»–çŠ¶æ€
                    return;
                }

                // å¤„ç†éœ‡åŠ¨æ•ˆæœ
                if (bossNian.shakeTimer > 0) {
                    bossNian.shakeTimer--;
                    bossNian.shakePhase += 0.8; // éœ‡åŠ¨é¢‘ç‡
                    // å¹…åº¦é€’å‡ï¼šä»3é€æ¸å‡å°åˆ°0
                    bossNian.shakeAmplitude = 3 * (bossNian.shakeTimer / 30);
                } else {
                    bossNian.shakeAmplitude = 0;
                }

                bossNian.animTimer++;
                if (bossNian.animTimer > 15) {
                    bossNian.animFrame++;
                    bossNian.animTimer = 0;
                }

                // BOSSçŠ¶æ€æœº
                switch (bossNian.state) {
                    case 'entering':
                        // ä»è¾¹ç•Œåè¿›å…¥
                        bossNian.x -= 2;
                        if (bossNian.x <= 600) {
                            bossNian.state = 'moving';
                            bossNian.moveTimer = 120;
                            // éšæœºé€‰æ‹©ä¸€ä¸ªç§»åŠ¨ç›®æ ‡ä½ç½®
                            bossNian.targetX = 200 + Math.random() * 350;
                            bossNian.targetY = 100 + Math.random() * 400;
                        }
                        break;

                    case 'moving':
                        // å‘ç›®æ ‡ä½ç½®ç§»åŠ¨
                        const dx = bossNian.targetX - bossNian.x;
                        const dy = bossNian.targetY - bossNian.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);

                        if (dist > 5) {
                            bossNian.x += (dx / dist) * difficultySettings[currentDifficulty].bossMoveSpeed;
                            bossNian.y += (dy / dist) * difficultySettings[currentDifficulty].bossMoveSpeed;
                        } else {
                            // åˆ°è¾¾ç›®æ ‡ï¼Œå¼€å§‹æ”»å‡»
                            bossNian.state = 'attacking';
                            bossNian.roarTimer = 60;
                        }
                        break;

                    case 'attacking':
                        bossNian.roarTimer--;

                        // æ€’å¼åŠ¨ç”»
                        if (bossNian.roarTimer > 30) {
                            bossNian.isRoaring = true;
                        } else {
                            bossNian.isRoaring = false;
                            // å‘å°„é­ç‚®é›¨
                            if (bossNian.roarTimer % 8 === 0 && bossNian.roarTimer > 0) {
                                spawnBossBulletRain();
                            }
                        }

                        // æ”»å‡»ç»“æŸåå›åˆ°ç§»åŠ¨çŠ¶æ€
                        if (bossNian.roarTimer <= 0) {
                            bossNian.state = 'moving';
                            bossNian.moveTimer = 120;
                            bossNian.targetX = 200 + Math.random() * 350;
                            bossNian.targetY = 100 + Math.random() * 400;
                        }
                        break;
                }

                // BOSSå‘å°„å¼¹å¹•
                if (timestamp - bossNian.lastFire > bossNian.fireRate) {
                    spawnBulletFromNian(bossNian);
                    bossNian.lastFire = timestamp;
                }
            }
        }

        // BOSSé­ç‚®é›¨æ”»å‡»
        function spawnBossBulletRain() {
            const bulletCount = 5;
            for (let i = 0; i < bulletCount; i++) {
                const startX = 100 + Math.random() * 600;
                bullets.push({
                    x: startX,
                    y: -20,
                    size: 10 + Math.random() * 8,
                    angle: Math.PI / 2 + (Math.random() - 0.5) * 0.3, // å‘ä¸‹ç¨å¾®éšæœºè§’åº¦
                    speed: 2 + Math.random() * 1.5,
                    color: '#ff4444'
                });
            }
        }

        // æ›´æ–°å¼¹å¹•
        function updateBullets() {
            bullets = bullets.filter(bullet => {
                bullet.x += Math.cos(bullet.angle) * bullet.speed;
                bullet.y += Math.sin(bullet.angle) * bullet.speed;

                // é£å‡ºå±å¹•å°±ç§»é™¤ï¼ˆä¸å†è®¡åˆ†ï¼‰
                if (bullet.x < -30 || bullet.y < -30 || bullet.y > 630) {
                    return false;
                }
                return true;
            });
        }

        // æ›´æ–°é¥ºå­
        function updateDumplings() {
            dumplings = dumplings.filter(dumpling => {
                dumpling.y += dumpling.speed;

                if (dumpling.y > 630) return false;

                const dx = dumpling.x - (witch.x + 24);
                const dy = dumpling.y - (witch.y + 24);
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (distance < 30) {
                    if (witch.lives < 3) {
                        witch.lives++;
                    }
                    createFirework(dumpling.x, dumpling.y);
                    return false;
                }

                return true;
            });
        }

        // æ›´æ–°æ‰‹å¥—
        function updateGloves() {
            gloves = gloves.filter(glove => {
                glove.y += glove.speed;

                if (glove.y > 630) return false;

                const dx = glove.x - (witch.x + 24);
                const dy = glove.y - (witch.y + 24);
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (distance < 30 && !witch.hasGlove) {
                    witch.hasGlove = true;
                    createFirework(glove.x, glove.y);
                    return false;
                }

                return true;
            });
        }

        // æ›´æ–°æŠ•æ·çš„æ‰‹å¥—
        function updateThrownGloves() {
            thrownGloves = thrownGloves.filter(glove => {
                glove.x += glove.vx;
                glove.y += glove.vy;
                glove.vy += 0.3; // é‡åŠ›
                glove.rotation += 0.15; // æ—‹è½¬æ•ˆæœ

                // æ£€æµ‹æ˜¯å¦å‡»ä¸­æ™®é€šå¹´å…½
                for (let i = nians.length - 1; i >= 0; i--) {
                    const nian = nians[i];
                    const dx = glove.x - (nian.x + 30); // è°ƒæ•´ä¸ºä¸­å¿ƒç‚¹ï¼ˆå¹´å…½æ˜¯60x60ï¼‰
                    const dy = glove.y - (nian.y + 30);
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance < 35) { // è°ƒæ•´ç¢°æ’åŠå¾„
                        // è§¦å‘å—å‡»æ•ˆæœï¼šé¡¿å¸§0.1sï¼ˆ6å¸§ï¼‰+ éœ‡åŠ¨0.5sï¼ˆ30å¸§ï¼‰
                        nian.hitFreezeTimer = 6; // 0.1ç§’é¡¿å¸§
                        nian.shakeTimer = 30; // 0.5ç§’éœ‡åŠ¨
                        nian.shakeAmplitude = 3; // åˆå§‹éœ‡åŠ¨å¹…åº¦
                        nian.shakePhase = 0; // é‡ç½®éœ‡åŠ¨ç›¸ä½

                        nian.hitTimer = 10;
                        nian.hp--;
                        createFirework(nian.x + 30, nian.y + 30);

                        // æ£€æŸ¥æ˜¯å¦æ­»äº¡
                        if (nian.hp <= 0) {
                            // æ­»äº¡æ—¶æ”¾çƒŸèŠ±
                            createFirework(nian.x + 30, nian.y + 30);
                            createFirework(nian.x + 15, nian.y + 15);
                            createFirework(nian.x + 45, nian.y + 15);
                            createFirework(nian.x + 15, nian.y + 45);
                            createFirework(nian.x + 45, nian.y + 45);

                            // ç§»é™¤å¹´å…½
                            nians.splice(i, 1);
                            killedNians++;

                            // æ£€æŸ¥æ˜¯å¦åº”è¯¥å‡ºç°BOSS
                            if (killedNians >= 5 && !bossActive) {
                                setTimeout(spawnBossNian, 2000);
                            }
                        }
                        return false;
                    }
                }

                // æ£€æµ‹æ˜¯å¦å‡»ä¸­BOSSå¹´å…½
                if (bossNian) {
                    const dx = glove.x - (bossNian.x + 60);
                    const dy = glove.y - (bossNian.y + 60);
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance < 70) {
                        // è§¦å‘å—å‡»æ•ˆæœï¼šé¡¿å¸§0.1sï¼ˆ6å¸§ï¼‰+ éœ‡åŠ¨0.5sï¼ˆ30å¸§ï¼‰
                        bossNian.hitFreezeTimer = 6; // 0.1ç§’é¡¿å¸§
                        bossNian.shakeTimer = 30; // 0.5ç§’éœ‡åŠ¨
                        bossNian.shakeAmplitude = 3; // åˆå§‹éœ‡åŠ¨å¹…åº¦
                        bossNian.shakePhase = 0; // é‡ç½®éœ‡åŠ¨ç›¸ä½

                        bossNian.hitTimer = 10;
                        bossNian.hp--;
                        createFirework(bossNian.x + 60, bossNian.y + 60);

                        // BOSSæ­»äº¡
                        if (bossNian.hp <= 0) {
                            bossDeath();
                        }
                        return false;
                    }
                }

                // é£å‡ºå±å¹•
                if (glove.x > 850 || glove.x < -50 || glove.y > 650 || glove.y < -50) {
                    return false;
                }

                return true;
            });
        }

        // BOSSæ­»äº¡æ•ˆæœï¼ˆç²’å­åŒ–çˆ†ç‚¸ï¼‰
        function bossDeath() {
            bossDefeated = true;

            // åˆ›å»ºå¤§é‡ç²’å­
            const particleCount = 100;
            for (let i = 0; i < particleCount; i++) {
                const angle = (i * 360 / particleCount) * Math.PI / 180;
                const speed = 3 + Math.random() * 5;
                particles.push({
                    x: bossNian.x + 60,
                    y: bossNian.y + 60,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    life: 60,
                    maxLife: 60,
                    size: 3 + Math.random() * 4,
                    color: ['#D32F2F', '#FF5722', '#FFD700', '#FFF176'][Math.floor(Math.random() * 4)]
                });
            }

            // åˆ›å»ºå¤šä¸ªçƒŸèŠ±
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    createFirework(
                        bossNian.x + 60 + (Math.random() - 0.5) * 100,
                        bossNian.y + 60 + (Math.random() - 0.5) * 100
                    );
                }, i * 100);
            }

            bossNian = null;
            bossActive = false;

            // æ¸¸æˆèƒœåˆ©
            setTimeout(() => {
                gameWin();
            }, 2000);
        }

        // æ›´æ–°ç²’å­æ•ˆæœ
        function updateParticles() {
            particles = particles.filter(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.1; // è½»å¾®é‡åŠ›
                p.life--;

                return p.life > 0;
            });
        }

        // ç»˜åˆ¶ç²’å­æ•ˆæœ
        function drawParticles() {
            particles.forEach(p => {
                ctx.save();
                ctx.globalAlpha = p.life / p.maxLife;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            });
        }

        // æ¸¸æˆèƒœåˆ©
        function gameWin() {
            gameRunning = false;
            gameWon = true;
            finalTimeElement.textContent = formatTime(gameTime);
            finalScoreElement.textContent = killedNians;
            gameOverTitle.textContent = 'æ–°å¹´å¿«ä¹ï¼';
            gameOverMessage.textContent = 'æ­å–œä½ å‡»è´¥äº†å¹´å…½BOSSï¼';
            gameOverScreen.style.display = 'block';
        }

        // ç¢°æ’æ£€æµ‹
        function checkCollisions() {
            if (witch.invincible) return;

            bullets = bullets.filter(bullet => {
                const dx = bullet.x - (witch.x + 24);
                const dy = bullet.y - (witch.y + 24);
                const distance = Math.sqrt(dx * dx + dy * dy);

                // å¦‚æœæœ‰æ‰‹å¥—ï¼Œå¯ä»¥é˜²å¾¡ä¸€æ¬¡
                if (distance < bullet.size + 15) {
                    if (witch.hasGlove) {
                        witch.hasGlove = false;
                        createFirework(bullet.x, bullet.y);
                        return false;
                    }

                    witch.lives--;
                    witch.invincible = true;
                    witch.invincibleTimer = 90;
                    witch.hurtTimer = 15;

                    createFirework(witch.x + 24, witch.y + 24);

                    if (witch.lives <= 0) {
                        gameOver();
                    }
                    return false;
                }
                return true;
            });
        }

        // æ¸¸æˆç»“æŸï¼ˆå¤±è´¥ï¼‰
        function gameOver() {
            gameRunning = false;
            gameWon = false;
            finalTimeElement.textContent = formatTime(gameTime);
            finalScoreElement.textContent = killedNians;
            gameOverTitle.textContent = 'æ¸¸æˆç»“æŸ';
            gameOverMessage.textContent = 'å¹´å…½æŠŠä½ æ‰“è´¥äº†...';
            gameOverScreen.style.display = 'block';
        }

        // é‡æ–°å¼€å§‹
        function restart() {
            witch.x = 100;
            witch.y = 300;
            witch.lives = 3;
            witch.invincible = false;
            witch.hurtTimer = 0;
            witch.hasGlove = false;
            bullets = [];
            dumplings = [];
            gloves = [];
            thrownGloves = [];
            fireworks = [];
            particles = [];
            nians = [];
            bossNian = null;
            killedNians = 0;
            bossActive = false;
            bossDefeated = false;
            gameRunning = true;
            gameWon = false;
            gameStarted = true;
            gameTime = 0;
            gameStartTime = Date.now();
            lastNianSpawn = 0;
            lastDumplingTime = 0;
            lastGloveTime = 0;
            lastBackgroundFirework = 0;
            gameLoopInitialized = false;
            gameOverScreen.style.display = 'none';
            spawnInitialNians(); // é‡æ–°å¼€å§‹æ—¶ç”Ÿæˆåˆå§‹ä¸¤åªå¹´å…½
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            gameStarted = true;
            gameRunning = true;
            startScreen.style.display = 'none';
            gameStartTime = Date.now();
            // é‡ç½®æ‰€æœ‰æ—¶é—´æˆ³ï¼Œé˜²æ­¢ç«‹å³ç”Ÿæˆå¤šä¸ªç‰©å“
            lastNianSpawn = performance.now();
            lastDumplingTime = performance.now();
            lastGloveTime = performance.now();
            gameLoopInitialized = false; // é‡æ–°åˆå§‹åŒ–æ—¶é—´æˆ³
            spawnInitialNians(); // ç”Ÿæˆåˆå§‹ä¸¤åªå¹´å…½
        }

        // é”®ç›˜äº‹ä»¶
        document.addEventListener('keydown', (e) => {
            if (keys.hasOwnProperty(e.key)) {
                keys[e.key] = true;
                e.preventDefault();
            }
        });

        document.addEventListener('keyup', (e) => {
            if (keys.hasOwnProperty(e.key)) {
                keys[e.key] = false;
            }
        });

        // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶ - å¼€å§‹æ‹–æ‹½ç„å‡†
        canvas.addEventListener('mousedown', (e) => {
            if (witch.hasGlove && e.button === 0) {
                const rect = canvas.getBoundingClientRect();
                isAiming = true;
                aimStartX = e.clientX - rect.left;
                aimStartY = e.clientY - rect.top;
                aimCurrentX = aimStartX;
                aimCurrentY = aimStartY;
            }
        });

        // é¼ æ ‡ç§»åŠ¨äº‹ä»¶ - æ›´æ–°æ‹–æ‹½ä½ç½®
        canvas.addEventListener('mousemove', (e) => {
            if (isAiming) {
                const rect = canvas.getBoundingClientRect();
                aimCurrentX = e.clientX - rect.left;
                aimCurrentY = e.clientY - rect.top;
            }
        });

        // é¼ æ ‡æŠ¬èµ·äº‹ä»¶ - æŠ•æ·
        canvas.addEventListener('mouseup', (e) => {
            if (witch.hasGlove && e.button === 0 && isAiming) {
                isAiming = false;

                // è®¡ç®—æ‹–æ‹½å‘é‡ï¼ˆåå‘ï¼‰
                const dx = aimStartX - aimCurrentX;
                const dy = aimStartY - aimCurrentY;

                // é™åˆ¶æœ€å¤§æ‹‰åŠ›
                const maxPull = 150;
                const pullDistance = Math.min(Math.sqrt(dx * dx + dy * dy), maxPull);
                const angle = Math.atan2(dy, dx);

                // åŠ›åº¦ç³»æ•°
                const power = pullDistance / 10;

                // åªæœ‰æ‹‰åŠ›è¶³å¤Ÿæ‰æŠ•æ·
                if (pullDistance > 20) {
                    witch.hasGlove = false;
                    thrownGloves.push({
                        x: witch.x + 44,
                        y: witch.y + 14,
                        vx: Math.cos(angle) * power,
                        vy: Math.sin(angle) * power,
                        rotation: 0
                    });
                }
            }
        });

        // é¼ æ ‡ç¦»å¼€canvas - å–æ¶ˆç„å‡†
        canvas.addEventListener('mouseleave', () => {
            isAiming = false;
        });

        // è§¦æ‘¸äº‹ä»¶æ”¯æŒï¼ˆè§¦æ§æ¿/è§¦æ‘¸å±ï¼‰
        canvas.addEventListener('touchstart', (e) => {
            if (witch.hasGlove && e.touches.length === 1) {
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                const touch = e.touches[0];
                isAiming = true;
                aimStartX = touch.clientX - rect.left;
                aimStartY = touch.clientY - rect.top;
                aimCurrentX = aimStartX;
                aimCurrentY = aimStartY;
            }
        }, { passive: false });

        canvas.addEventListener('touchmove', (e) => {
            if (isAiming && e.touches.length === 1) {
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                const touch = e.touches[0];
                aimCurrentX = touch.clientX - rect.left;
                aimCurrentY = touch.clientY - rect.top;
            }
        }, { passive: false });

        canvas.addEventListener('touchend', (e) => {
            if (witch.hasGlove && isAiming) {
                e.preventDefault();
                isAiming = false;

                // è®¡ç®—æ‹–æ‹½å‘é‡ï¼ˆåå‘ï¼‰
                const dx = aimStartX - aimCurrentX;
                const dy = aimStartY - aimCurrentY;

                // é™åˆ¶æœ€å¤§æ‹‰åŠ›
                const maxPull = 150;
                const pullDistance = Math.min(Math.sqrt(dx * dx + dy * dy), maxPull);
                const angle = Math.atan2(dy, dx);

                // åŠ›åº¦ç³»æ•°
                const power = pullDistance / 10;

                // åªæœ‰æ‹‰åŠ›è¶³å¤Ÿæ‰æŠ•æ·
                if (pullDistance > 20) {
                    witch.hasGlove = false;
                    thrownGloves.push({
                        x: witch.x + 44,
                        y: witch.y + 14,
                        vx: Math.cos(angle) * power,
                        vy: Math.sin(angle) * power,
                        rotation: 0
                    });
                }
            }
        }, { passive: false });

        restartBtn.addEventListener('click', restart);
        startBtn.addEventListener('click', startGame);

        // éš¾åº¦é€‰æ‹©åŠŸèƒ½
        const difficultyBtns = document.querySelectorAll('.difficulty-btn');
        difficultyBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
                difficultyBtns.forEach(b => b.classList.remove('selected'));
                // æ·»åŠ å½“å‰æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
                btn.classList.add('selected');
                // è®¾ç½®å½“å‰éš¾åº¦
                currentDifficulty = btn.dataset.difficulty;
            });
        });

        // æ¸¸æˆå¾ªç¯
        let lastDumplingTime = 0;
        let lastGloveTime = 0;
        let gameLoopInitialized = false;

        function gameLoop(timestamp) {
            ctx.clearRect(0, 0, 800, 600);

            // åˆå§‹åŒ–æ—¶é—´æˆ³
            if (!gameLoopInitialized) {
                lastNianSpawn = timestamp;
                lastDumplingTime = timestamp;
                lastGloveTime = timestamp;
                lastBackgroundFirework = timestamp;
                gameLoopInitialized = true;
            }

            // æ›´æ–°æ¸¸æˆæ—¶é—´
            if (gameRunning && gameStarted) {
                gameTime = (Date.now() - gameStartTime) / 1000;
            }

            drawBackground();

            if (gameRunning && gameStarted) {
                // ç”Ÿæˆå¹´å…½ï¼ˆæ¯15ç§’ï¼‰
                if (!bossActive && timestamp - lastNianSpawn > 15000) {
                    spawnNian();
                    lastNianSpawn = timestamp;
                }

                // ç”Ÿæˆé¥ºå­
                if (timestamp - lastDumplingTime > 8000) {
                    spawnDumpling();
                    lastDumplingTime = timestamp;
                }

                // ç”Ÿæˆæ‰‹å¥—ï¼ˆæ¯3ç§’ï¼‰
                if (timestamp - lastGloveTime > 3000) {
                    spawnGlove();
                    lastGloveTime = timestamp;
                }

                updateWitch();
                updateNians(timestamp);
                updateBullets();
                updateDumplings();
                updateGloves();
                updateThrownGloves();
                updateParticles();
                checkCollisions();
            }

            // æŒç»­æ›´æ–°ç²’å­ï¼ˆå³ä½¿æ¸¸æˆç»“æŸï¼‰
            updateParticles();

            // æŒç»­ç”ŸæˆèƒŒæ™¯çƒŸèŠ±ï¼ˆæ¯1.5ç§’ä¸€ä¸ªï¼‰
            if (timestamp - lastBackgroundFirework > 1500) {
                spawnBackgroundFirework();
                lastBackgroundFirework = timestamp;
            }

            drawFireworks();
            drawParticles();

            // åªåœ¨æ¸¸æˆå¼€å§‹åæ‰ç»˜åˆ¶æ¸¸æˆå…ƒç´ 
            if (gameStarted) {
                drawBullets();
                drawDumplings();
                drawGloves();
                drawThrownGloves();
                drawTrajectory();

                // ç»˜åˆ¶å¹´å…½
                nians.forEach(nian => drawNian(nian));

                // ç»˜åˆ¶BOSSå¹´å…½
                if (bossNian) {
                    drawNian(bossNian);
                }

                if (gameRunning) {
                    drawWitch();
                }
            }
            drawUI();

            requestAnimationFrame(gameLoop);
        }

        // å¯åŠ¨æ¸¸æˆå¾ªç¯ï¼ˆä½†ä¸ç«‹å³å¼€å§‹æ¸¸æˆï¼‰
        gameLoop(0);
    </script>
</body>
</html>
